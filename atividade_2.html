<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maria Moog - Class. afetiva</title>
  <link rel="shortcut icon" href="./assets/img/icon.png" type="image/x-icon">
  <link rel="stylesheet" href="./assets/css/fonts.css">
  <link rel="stylesheet" href="./assets/css/styles.css">
</head>

<body>
  <div class="container">
  </div>
  <script src="./assets/js/font-awesome.js?ts=" + new Date().getTime()></script>
  <script src="./assets/js/repository.js?ts=" + new Date().getTime()></script>
  <script>
    const db = new IndexedDBRepository("db", 2);

    const data = {
      pt: [
        { word: "Afeto" },
        { word: "Morte" },
        { word: "Nariz" },
        { word: "Vitória" },
        { word: "Frustração" },
        { word: "Lápis" },
        { word: "Perda" },
        { word: "Decepção" },
        { word: "Mesa" },
        { word: "Pobreza" },
        { word: "Estupro" },
        { word: "Areia" },
        { word: "Traição" },
        { word: "Sucesso" },
        { word: "Colher" },
        { word: "Dor" },
        { word: "Feliz" },
        { word: "Unha" },
        { word: "Homicídio" },
        { word: "Beijo" },
        { word: "Tinta" },
        { word: "Ódio" },
        { word: "Abraço" },
        { word: "Xícara" },
        { word: "Elogio" },
        { word: "Doença" },
        { word: "Pé" },
        { word: "Prazer" },
        { word: "Amizade" },
        { word: "Prédio" },
        { word: "Sorriso" },
        { word: "Acidente" },
        { word: "Borracha" },
        { word: "Bondade" },
        { word: "Maligno" },
        { word: "Cesto" },
        { word: "Carinho" },
        { word: "Diversão" },
        { word: "Vidro" },
        { word: "Aborto" },
        { word: "Amor" },
        { word: "Madeira" },
        { word: "Preconceito" },
        { word: "Gargalhada" },
        { word: "Consultório" },
      ],
      en: [
        { word: "Frustration" },
        { word: "Success" },
        { word: "Nose" },
        { word: "Loss" },
        { word: "Care" },
        { word: "Office" },
        { word: "Poverty" },
        { word: "Disease" },
        { word: "Wood" },
        { word: "Disappointment" },
        { word: "Compliment" },
        { word: "Pencil" },
        { word: "Affection" },
        { word: "Hug" },
        { word: "Table" },
        { word: "Murder" },
        { word: "Happy" },
        { word: "Glass" },
        { word: "Friendship" },
        { word: "Betrayal" },
        { word: "Basket" },
        { word: "Smile" },
        { word: "Laughter" },
        { word: "Sand" },
        { word: "Fun" },
        { word: "Kindness" },
        { word: "Spoon" },
        { word: "Rape" },
        { word: "Hate" },
        { word: "Eraser" },
        { word: "Kiss" },
        { word: "Evil" },
        { word: "Building" },
        { word: "Death" },
        { word: "Victory" },
        { word: "Nail" },
        { word: "Pleasure" },
        { word: "Love" },
        { word: "Foot" },
        { word: "Abortion" },
        { word: "Pain" },
        { word: "Cup" },
        { word: "Accident" },
        { word: "Prejudice" },
        { word: "Paint" },
      ],
    };

    const language = window.localStorage.getItem("language") ?? "pt";
    const selectedLanguageData = data[language];

    async function getCurrentUser() {
      const currentUser = window.localStorage.getItem("currentUser");
      if (currentUser) {
        return JSON.parse(currentUser);
      }
      return null;
    }

    function sleep(seconds) {
      return new Promise((resolve) => {
        setTimeout(resolve, seconds * 1000);
      });
    }

    async function start() {
      const currentUser = await getCurrentUser();
      if (!currentUser) {
        alert("Usuário não encontrado");
        return;
      }

      await db.init(["activity"]);
      const userAlreadyMadeActivity = await db.search("activity", { email: currentUser.email, activity_type: "affective_classification" });
      if (userAlreadyMadeActivity.length > 0) {
        alert("Usuário já fez esta atividade");
        window.location.href = "./index.html";
        return;
      }

      const testContainer = document.createElement("div");
      testContainer.classList.add("affective-classification");
      testContainer.style.position = "fixed";
      testContainer.style.top = "50%";
      testContainer.style.left = "50%";
      testContainer.style.transform = "translate(-50%, -50%)";
      testContainer.style.fontSize = "60px";
      testContainer.style.fontWeight = "bold";
      testContainer.style.textAlign = "center";
      document.body.appendChild(testContainer);

      const results = [];
      let index = 0;
      let word = selectedLanguageData[index].word;

      await showTimer(5);
      await showWord(index);

      function showTimer(count) {
        return new Promise((resolve) => {
          const countContainer = document.createElement("div");
          countContainer.style.fontSize = "60px";
          countContainer.style.fontWeight = "bold";
          countContainer.style.textAlign = "center";
          countContainer.innerText = count;
          testContainer.appendChild(countContainer);

          const interval = setInterval(() => {
            count--;
            if (count === 0) {
              testContainer.removeChild(countContainer);
              clearInterval(interval);
              resolve();
            } else {
              countContainer.innerText = count;
            }
          }, 1000);
        });
      }

      async function showWord(index) {
        const words = selectedLanguageData;
        if (index >= words.length) {
          const restartButton = document.createElement("button");
          restartButton.innerText = "Tela Inicial";
          restartButton.style.display = "block";
          restartButton.style.margin = "20px auto";
          restartButton.style.padding = "10px 15px";
          restartButton.style.fontSize = "18px";
          restartButton.style.border = "none";
          restartButton.style.background = "#6FA3EF";
          restartButton.style.color = "white";
          restartButton.style.borderRadius = "5px";
          restartButton.style.cursor = "pointer";
          restartButton.onclick = () => {
            window.location.href = "./index.html";
          };

          await db.init(["activity"]);
          if (userAlreadyMadeActivity.length === 0) {
            const params = {
              user_id: currentUser.id,
              username: currentUser.username,
              email: currentUser.email,
              language,
              activity_type: "affective_classification",
              results,
            };
            await db.add("activity", params);
          }

          await showResults();
          return;
        }

        word = words[index].word;

        testContainer.innerHTML = "";

        await sleep(1);

        const wordContainer = document.createElement("div");
        wordContainer.classList.add("word-container");
        wordContainer.style.fontSize = "60px";
        wordContainer.style.fontWeight = "bold";
        wordContainer.style.textAlign = "center";
        wordContainer.style.color = "#414141";
        wordContainer.style.marginBottom = "1rem";
        wordContainer.innerText = word;
        testContainer.appendChild(wordContainer);

        const emotionContainer = document.createElement("div");
        emotionContainer.classList.add("emotion-container");
        emotionContainer.style.fontWeight = "bold";
        emotionContainer.style.textAlign = "center";
        emotionContainer.style.display = "flex";
        emotionContainer.style.justifyContent = "space-between";
        emotionContainer.style.alignItems = "center";
        emotionContainer.style.alignContent = "center";
        emotionContainer.style.gap = "1rem";

        const emotions = ["nada emocional/neutra", "pouco emocional", "moderadamente emocional", "muito emocional", "completamente emocional"];
        emotions.forEach((emotion, i) => {
          const eContainer = document.createElement("a");
          eContainer.classList.add("emotion");
          eContainer.style.padding = "0.5rem";
          eContainer.style.border = "1px solid #ccc";
          eContainer.style.borderRadius = "5px";
          eContainer.style.cursor = "pointer";
          eContainer.style.fontSize = "0.8rem";
          eContainer.style.display = "flex";
          eContainer.style.alignItems = "center";
          eContainer.style.alignContent = "center";
          eContainer.style.whiteSpace = "nowrap";
          eContainer.innerText = emotion;
          eContainer.addEventListener("click", handleClick);
          emotionContainer.appendChild(eContainer);
        });

        testContainer.appendChild(emotionContainer);
      }

      async function handleClick(event) {
        const currentButton = event.target.closest(".emotion");
        updateResults(word, currentButton.innerText);
        await wordHighlight(currentButton);
        index = index + 1;
        await showWord(index);
      }

      function updateResults(word, emotion) {
        results.push({ word, emotion, username: currentUser.username, email: currentUser.email });
      }

      async function wordHighlight(button) {
        const allButtons = document.querySelectorAll(".emotion");
        allButtons.forEach(button => {
          button.removeEventListener("click", handleClick);
          button.style.opacity = "0.2";
        });
        button.style.opacity = "1";
        button.style.backgroundColor = "#414141";
        button.style.color = "#FFFFFF";
        await sleep(2);
      }

      async function showResults() {
        const currentUser = await getCurrentUser();
        if (!currentUser) return;

        await db.init(["activity"]);
        const allResults = await db.getAll("activity");

        const filteredActivities = allResults.filter((result) => {
          return (result.language === language);
        });

        const filteredResults = [];
        filteredActivities.forEach(activity => {
          activity.results.forEach(result => {
            filteredResults.push(result);
          });
        });

        const wordsList = data[language].map(item => item.word);

        const wordStats = {};

        wordsList.forEach(word => {
          wordStats[word] = {
            total: 0,
            emotions: {
              "nada emocional/neutra": 0,
              "pouco emocional": 0,
              "moderadamente emocional": 0,
              "muito emocional": 0,
              "completamente emocional": 0,
            },
          };
        });

        filteredResults.forEach(result => {
          const { word, emotion } = result;

          if (wordStats[word]) {
            wordStats[word].total++;
            wordStats[word].emotions[emotion]++;
          }
        });

        const resultsContainer = document.createElement("div");
        resultsContainer.classList.add("results-container");
        resultsContainer.style.margin = "20px auto";
        resultsContainer.style.width = "90%";
        resultsContainer.style.maxHeight = "60vh";
        resultsContainer.style.padding = "20px";
        resultsContainer.style.backgroundColor = "#ffffff";
        resultsContainer.style.borderRadius = "10px";
        resultsContainer.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
        resultsContainer.style.overflow = "auto";

        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        table.style.marginBottom = "20px";
        table.style.fontSize = "0.8rem";

        const headerRow = document.createElement("tr");
        headerRow.style.position = "sticky";
        headerRow.style.top = "-20px";
        headerRow.style.zIndex = "1";

        const headers = ["Palavra", "Nada emocional/neutra", "Pouco emocional", "Moderadamente emocional", "Muito emocional", "Completamente emocional"];
        headers.forEach(headerText => {
          const header = document.createElement("th");
          header.textContent = headerText;
          header.style.padding = "10px";
          header.style.border = "1px solid #cccccc";
          header.style.backgroundColor = "#414141";
          header.style.color = "#ffffff";
          header.style.whiteSpace = "nowrap";
          headerRow.appendChild(header);
        });
        table.appendChild(headerRow);

        wordsList.forEach(word => {
          const row = document.createElement("tr");
          const wordCell = document.createElement("td");
          wordCell.textContent = word;
          wordCell.style.padding = "10px";
          wordCell.style.border = "1px solid #cccccc";
          wordCell.style.backgroundColor = "#f5f5f5";
          wordCell.style.whiteSpace = "nowrap";
          row.appendChild(wordCell);

          const emotions = wordStats[word].emotions;
          const total = wordStats[word].total;

          Object.keys(emotions).forEach(emotion => {
            const count = emotions[emotion];
            const percentage = total > 0 ? ((count / total) * 100).toFixed(2) : "0.00";

            const cell = document.createElement("td");
            cell.textContent = `${count} (${percentage}%)`;
            cell.style.padding = "10px";
            cell.style.border = "1px solid #cccccc";
            cell.style.backgroundColor = "#f5f5f5";
            cell.style.whiteSpace = "nowrap";
            row.appendChild(cell);
          });

          table.appendChild(row);
        });

        resultsContainer.appendChild(table);

        const testContainer = document.querySelector(".affective-classification");
        if (testContainer) {
          testContainer.innerHTML = "";

          testContainer.appendChild(resultsContainer);

          const restartButton = document.createElement("button");
          restartButton.innerText = "Tela Inicial";
          restartButton.style.display = "block";
          restartButton.style.margin = "20px auto";
          restartButton.style.padding = "10px 15px";
          restartButton.style.fontSize = "18px";
          restartButton.style.border = "none";
          restartButton.style.background = "#6FA3EF";
          restartButton.style.color = "white";
          restartButton.style.borderRadius = "5px";
          restartButton.style.cursor = "pointer";
          restartButton.onclick = () => {
            window.location.href = "./index.html";
          };

          testContainer.appendChild(restartButton);
        }
      }
    }

    start();
  </script>
</body>

</html>